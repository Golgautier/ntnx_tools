{"status":{},"spec":{"name":"Brownfield App","description":"","resources":{"runbook":{"name":"cc84ca77_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e97d21db_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Decompile bp","kind":"app_task"},"to_task_reference":{"name":"Loop on IPs list","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Loop on IPs list","kind":"app_task"},"to_task_reference":{"name":"Clean","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Decompile bp","kind":"app_task"},{"name":"Loop on IPs list","kind":"app_task"},{"name":"Clean","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Decompile bp","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nexport PATH=$PATH:\/home\/calm\/nutanix\/calm-dsl\/venv\/bin\/\n\ncd \/tmp\n\nif [ ! -d \"bp-app\" ]\nthen\n    mkdir bp-app\nfi\n\ncd bp-app\n\ncalm update cache\nVALUE=`calm describe bp \"@@{Blueprint}@@\" | grep \"deployment_\" | awk '{ print $1 }' | paste -sd ',' -`\n\necho DeploymentName=$VALUE\necho AppsToBrownfield=`wc -l <<EOF\n@@{VMIP}@@\nEOF`","script_type":"sh","exit_status":[],"eval_scope":"local","eval_variables":["DeploymentName","AppsToBrownfield"],"login_credential_local_reference":{"name":"Jumphost","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Jumphost","kind":"app_endpoint"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"WHILE_LOOP","name":"Loop on IPs list","description":"","attrs":{"type":"","iterations":"@@{AppsToBrownfield}@@","exit_condition_type":"dont_care","loop_variable":"Iteration"},"child_tasks_local_reference_list":[{"name":"b1f71ec4_1_META","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"META","name":"b1f71ec4_1_META","description":"","attrs":{"type":""},"child_tasks_local_reference_list":[{"name":"Gets App IPs","kind":"app_task"},{"name":"Create brownfiled files","kind":"app_task"},{"name":"Brownfiled the app","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Gets App IPs","description":"","attrs":{"type":"","script":"#script\n\nmstr=\"\"\"@@{VMIP}@@\"\"\"\n\nline=mstr.splitlines()[@@{Iteration}@@]\n\nprint(\"IPs=\"+line)","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["IPs"]},"child_tasks_local_reference_list":[],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create brownfiled files","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\n\nBFILE=brownfield-@@{Iteration}@@.py\nNBDEP=`echo @@{DeploymentName}@@ | awk -F',' '{print NF}'`\n\ncd \/tmp\/bp-app\n\ncat >$BFILE <<EOF\nfrom calm.dsl.builtins import Brownfield as BF\nfrom calm.dsl.builtins import read_local_file\n\nEOF\n\n\nfor I in $(seq 1 $NBDEP)\ndo\n\tDEPNAME=`echo @@{DeploymentName}@@ | awk -F',' -v iter=\"$I\" '{ print $iter }'`\n    IP=`echo @@{IPs}@@ | awk -F',' -v iter=\"$I\" '{ print $iter }'`\n\n\t\n\tcat >>$BFILE <<EOF\nINSTANCE_NAME=\"$IP\"\n\nclass _$DEPNAME(BF.Deployment):\n\tname = \"$DEPNAME\"\n\tinstances = [\n\t\tBF.Vm.Ahv(ip_address=[INSTANCE_NAME])\n        ]\n        \nEOF\n\ndone","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"Jumphost","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Jumphost","kind":"app_endpoint"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Brownfiled the app","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nexport PATH=$PATH:\/home\/calm\/nutanix\/calm-dsl\/venv\/bin\/\n\ncd \/tmp\/bp-app\n\nif [ @@{AppsToBrownfield}@@ -eq 1 ]\nthen\n\tAPPNAME=@@{AppName}@@\nelse\n\tAPPNAME=@@{AppName}@@-@@{Iteration}@@\nfi\n\ncalm launch bp -a $APPNAME -b brownfield-@@{Iteration}@@.py \"@@{Blueprint}@@\" -i","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"Jumphost","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Jumphost","kind":"app_endpoint"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Clean","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nrm -rf \/tmp\/bp-app","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"Jumphost","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Jumphost","kind":"app_endpoint"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e97d21db_dag","kind":"app_task"},"variable_list":[{"type":"LOCAL","name":"AppName","description":"Will be postfixed with -x if you enter multiple VM to brownfield.","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Application Name","attrs":{"type":""},"editables":{"value":true},"value":"test-gautier"},{"type":"HTTP_LOCAL","name":"Blueprint","description":"","options":{"type":"HTTP","attrs":{"type":"HTTP","method":"POST","connection_timeout":120,"headers":[],"url":"https:\/\/localhost:9440\/api\/nutanix\/v3\/blueprints\/list","request_body":"{\n\"kind\": \"blueprint\"\n}","content_type":"application\/json","expected_response_params":[{"type":"","status":"SUCCESS","code_range_list":[{"start_code":202,"end_code":202},{"start_code":200,"end_code":200}]}],"authentication":{"type":"basic_with_cred","credential_local_reference":{"name":"SelfService","kind":"app_credential"}},"response_paths":{"Blueprint":"$.entities[*].metadata.name"},"tls_verify":false,"proxy_type":"","retry_count":1,"retry_interval":1,"internal_service":"","internal_service_method":""}},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"Blueprint to use","attrs":{"type":""},"editables":{"value":true},"value":"Test-brownfiled"},{"type":"LOCAL","name":"VMIP","description":"Enter IPs of the VP to import. 1 app per line, if you have multiple IPs for one app, use comma as delimiter","regex":{"value":"^(.|\\n)*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"MULTILINE_STRING","label":"VMs IPs","attrs":{"type":""},"editables":{"value":true},"value":"10.55.82.133\n10.55.82.147"}]},"endpoint_definition_list":[],"credential_definition_list":[{"type":"PASSWORD","name":"SelfService","description":"","username":"admin","secret":{"attrs":{"secret_reference":{},"is_secret_modified":false}},"cred_class":"static"},{"type":"PASSWORD","name":"Jumphost","description":"","username":"calm","secret":{"attrs":{"secret_reference":{},"is_secret_modified":false}},"cred_class":"static"}],"default_target_reference":{"name":"Jumphost","kind":"app_endpoint"},"endpoints_information":[{"endpoint_reference":{"name":"Jumphost","kind":"app_endpoint"},"description":"Calm Compagnon"}],"client_attrs":{}}},"api_version":"3.0","product_version":"4.0.0","metadata":{"last_update_time":"1741197650909878","creation_time":"1741074461594307","spec_version":37,"name":"Brownfield App","kind":"runbook"},"contains_secrets":false}