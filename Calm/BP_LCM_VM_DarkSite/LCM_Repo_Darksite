{"status":{},"contains_secrets":false,"product_version":"3.6.0","spec":{"description":"Deploy VM used as repository for LCM on darksite.","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"93cbff9e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0567c1d3_runbook","main_task_local_reference":{"kind":"app_task","name":"93cbff9e_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"ac561200_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"538dbba7_runbook","main_task_local_reference":{"kind":"app_task","name":"ac561200_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"25da163b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"84e80a2b_runbook","main_task_local_reference":{"kind":"app_task","name":"25da163b_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"624f7643_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"821c77f3_runbook","main_task_local_reference":{"kind":"app_task","name":"624f7643_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"fb1d2321_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"53337fe5_runbook","main_task_local_reference":{"kind":"app_task","name":"fb1d2321_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"LCM_Darksite","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":true,"login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"os_type":"Linux","create_spec":{"name":"vm-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","vpc_reference":null,"ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"ec063efc-c0c4-4f08-8d8c-6c9dace9b71e"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config \npreserve_hostname: false\nfqdn: lcm-darksite.local\nusers:\n  - name: @@{NUTANIX.username}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    @@{NUTANIX.username}@@:@@{NUTANIX.secret}@@\n  expire: False\nssh_pwauth: true"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"366b294d-81b5-4dd9-af44-45dd940b9751","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-Stream.qcow2","uuid":"adfb6a3d-850f-48ed-badb-edf7b3f53e73"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":{"kind":"cluster","type":"","name":"PHX-POC238","uuid":"0005eeb7-a2b3-eb56-7031-48df37b03304"},"categories":{}},"variable_list":[]}],"credential_definition_list":[{"username":"nutanix","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"NUTANIX","cred_class":"static"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"HPOC_ADMIN","cred_class":"static"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Extend DIsk"},{"kind":"app_task","name":"Udpate OS"},{"kind":"app_task","name":"install wget"},{"kind":"app_task","name":"Install httpd"}],"name":"76425918_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Extend DIsk"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Udpate OS"}},{"from_task_reference":{"kind":"app_task","name":"Udpate OS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install wget"}},{"from_task_reference":{"kind":"app_task","name":"install wget"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install httpd"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Extend DIsk","attrs":{"script":"vmUuid = '@@{id}@@'\ndiskSize = 50 # GB\npcAddress = '127.0.0.1'\npcUsername = '@@{HPOC_ADMIN.username}@@'\npcPassword = '@@{HPOC_ADMIN.secret}@@'\n\n# ============== DO NO CHANGE AFTER THIS ===============\n\nusrPass = '{}:{}'.format(pcUsername,pcPassword)\nb64Pass = base64.b64encode(usrPass)\n\n# Get VM\napi_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/vms\/{}'.format(pcAddress,vmUuid)\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json', 'Authorization': 'Basic {}'.format(b64Pass)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Power off VM and extend disk\ndel resp['status']\n\ndisk_size_mib = diskSize * 1024\ndisk_size_bytes = disk_size_mib * 1024**2\n\nresp['spec']['resources']['disk_list'][0]['disk_size_mib'] = disk_size_mib\nresp['spec']['resources']['disk_list'][0]['disk_size_bytes'] = disk_size_bytes\nresp['spec']['resources']['power_state'] = 'OFF'\n\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/tasks\/{}'.format(pcAddress,taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Wait for VM to power off\napi_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/vms\/{}'.format(pcAddress,vmUuid)\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    power_state = resp['status']['resources']['power_state']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nstate = \"\"\nwhile state != \"OFF\":\n    api_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/vms\/{}'.format(pcAddress,vmUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']['resources']['power_state']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Power on VM\ndel resp['status']\n\nresp['spec']['resources']['power_state'] = 'ON'\n\napi_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/vms\/{}'.format(pcAddress,vmUuid)\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/{}:9440\/api\/nutanix\/v3\/tasks\/{}'.format(pcAddress,taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\nprint(\"OS disk extended to {} GB\".format(diskSize))\n\n# Wait until VM boots\nsleep(60)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Udpate OS","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo yum update -y\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"install wget","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo yum install wget -y","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Install httpd","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\nsudo yum install httpd -y\n\nsudo mkdir -p \/var\/www\/html\/release \n\nsudo systemctl enable httpd\nsudo systemctl start httpd","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"b4f49eb2_runbook","main_task_local_reference":{"kind":"app_task","name":"76425918_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"3f0828b2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"92145db5_runbook","main_task_local_reference":{"kind":"app_task","name":"3f0828b2_dag"},"variable_list":[]},"upgrade_runbook":{}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"067e1dec_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"LCM_Darksite"},"variable_list":[],"description":""}],"environment_reference_list":[],"application_url":"","description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Download package"},{"kind":"app_task","name":"Extract"}],"name":"369480f8_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Download package"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Extract"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Download package","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\ncd \/var\/www\/html\/release\n\nsudo wget -O bundle.tgz \"@@{SourceURL}@@\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Extract","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n\ncd \/var\/www\/html\/release\n\nsudo tar xvzf bundle.tgz","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"666a998e_runbook","main_task_local_reference":{"kind":"app_task","name":"369480f8_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"Enter Source URL of Nutanix package to store on this LCM repository","data_type":"BASE","type":"LOCAL","name":"SourceURL","value":"","label":"Source URL","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Upload new version"}],"name":"Default","restore_config_list":[],"snapshot_config_list":[],"patch_list":[],"variable_list":[]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"NUTANIX"},"type":"USER"},"name":"LCM_DarkSite_Repository"},"api_version":"3.0","metadata":{"last_update_time":"1670422116390115","kind":"blueprint","spec_version":18,"creation_time":"1670406454601268","categories":{"TemplateType":"Vm"},"name":"LCM_DarkSite_Repository"}}